---
title: "3.1) Processes behind migration()"
author: "Hugo FlÃ¡vio"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{3.1) Processes behind migration()}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Index

1. [Preparing your data](a-0_workspace_requirements.html)
    1. [Structuring the study area](a-1_study_area.html)
    1. [Creating a distances matrix](a-2_distances_matrix.html)
1. [explore()](b-0_explore.html)
    1. [From raw to movements](b-1_explore_processes.html)
    1. [Inspecting the explore() results](b-2_explore_results.html)
1. [migration()](c-0_migration.html)
    1. [__Processes behind migration()__](c-1_migration_processes.html)
    1. [Inspecting the migration() results](c-2_migration_results.html)
    1. [Manual mode in migration()](c-3_migration_manual_mode.html)
    1. [One-way efficiency estimations](c-4_migration_efficiency.html)
1. [residency()](d-0_residency.html)
    1. [Processes behind residency()](d-1_residency_processes.html)
    1. [Inspecting the residency() results](d-2_residency_results.html)
    1. [Multi-way efficiency estimations](d-3_residency_efficiency.html)
1. [Errors and messages](e-0_messages.html)


Note: 
  : The processes behind one-way efficiency estimations are [explained in this manual page.](c-4_migration_efficiency.html)

## Aditional movement processes

The initial processes of migration() are the same as those from [the explore() function](b-1_explore_processes.html). However, when it comes to movement validity, actel will now also check if the fish was detected at an array that is not directly or indirectly below its release site. Should this happen, the following warning will be issued:

````
W: Fish R64K-1234 was detected in an array that is not after its release site! Opening relevant data for inspection.
   Release site: Trap
   Expected first array: River3

[...]

You may either:
  a) Stop the analysis if the expected first array is wrong;
  b) Continue as is (does not impact the results);
  c) Render a movement event invalid, if you are confident it is a false detection.

Decision:(a/b/c/comment)
````

Note:
  : An array is considered "behind the release site" if it is not part of the arrays to which the release array connects directly or indirectly. You can find the arrays considered directly or indirectly after/below of each array by checking the [arrays object](b-2_explore_results.html#arrays).

## Compiling a timetable

Once the movement events have been defined, they will be used to fill in the timetable, which is the most important step of migration(). For each fish, actel will find out the first and last valid movement event for each of the [study area's sections](a-1_study_area.html#sections). Once actel determines when the fish entered and left the study area's sections, it becomes possible to determine the fish's fate.

Note:
  : This process is semi-automatic: If the fish behaves as expected (i.e. linear migration), actel can easily find what it needs, but if there are some odd movement events, actel will ask for help to ensure everything is making sense.

### Odd behaviour

Actel expects your fish to move linearly from the release site to the last array on your study area (hence why [ordering the arrays properly](a-1_study_area.html#arrays) is very important). If this happens, the task of obtaining the first and last times in each section is very simple. However, sometimes fish like to play funny games in your study area, and things can get a bit trickier:

### Backwards movements

Tagged fish can move backwards either because they are reluctant of the new environments or because something ate them and you are now tracking the predator. The very first evidence of this is that the arrays to which each movement event belongs will no longer be arranged as expected. 

If this happens, but then the fish continues its journey, then the last movement events on each section will still be ordered as expected. Otherwise, if the fish moves backwards and then never returns, then the last movement events of each section will also be in an unexpected order. 

Let's have a look at two examples:

#### A) Movement events unordered, but last events ordered

<img src="event_order_a1.svg" alt="drawing" width="330"/> <img src="event_order_a2.svg" alt="drawing" width="330"/>

In this example, the fish starts by moving towards the Fjord, as expected, but then the moves back upstream into the river again. However, the fish then moves back in the expected direction and eventually leaves the study area. In this case, the last event in the Fjord will be after the last event in the River.

Since the backwards movements imply going to an anterior section, this has direct impact on the timetable assignment. As such, you will receive a warning:

````
W: Inter-section backwards movements were detected for Fish R64K-4456.
Would you like to see the movement table for fish R64K-4456 ?(y/N/comment)
````

By default, actel will consider the very last event of each section as the point when the fish left that section. For this example, that means that the fish would be considered to have left the river (for the last time) after the U turn, and then entered the fjord and finally left. This is graphically shown in the left pannel: the dashed movement events would not be considered.


#### B) Both Movement events and last events are unordered

<img src="event_order_b1.svg" alt="drawing" width="330"/> <img src="event_order_b2.svg" alt="drawing" width="330"/>

In this example, contrary to the above, the fish moves back into the river and then disappears. This means that the last event in the Fjord is actually **before** the last event in the River. 

This has both an impact on the assignment of times and on the assignment of the fish's fate. Unlike above, where you could choose not to take action, this situation will require your intervention.

````
W: Inter-section backwards movements were detected for Fish R64K-4526 and the last events are not ordered!
   Opening movements list for inspection.
````

If actel were to keep the default rules (i.e. the fish left the river after leaving the fjord), then it would be impossible to find a suitable first Fjord event. There are multiple options you can follow here, e.g.:

1. Discard the Fjord detections

2. Assume the fish was predated after reaching the end of the study area, and discard the following detections (example shown in the right pannel)

There is no universal answer to this, you must analyse your scenario and decide the best course of action.

<span style="color:red">Note:</span>
  : If your many of your fish are performing migrations __within__ the study area, you should consider using the [residency() function](d-0_residency.html) instead.
  : Even though the dashed events are discarded for time analysis, the number of backwards movements displayed by each fish will still be recorded in the [`status.df` object](c-2_migration_results.html#status.df).

#### Correcting the last events

Whether because you answered 'y' on example **A**, or because you were faced with a situation similar to example **B**, actel will show you the following:

````
[...]
Current last events: 6, 20, 33 (River, Fjord, Sea).

Would you like to edit the last valid events?(y/N/comment) 
````

The "Current last events" are pre-selected by actel for each section. If you want to edit any of these, you just have to reply "y" to the current question, select which last event you want to edit (1, 2 or 3 in this case) and the new movement event that should be considered the last event:

````
Would you like to edit the last valid events?(y/N/comment) y
Which last valid event would you like to edit? (1-3/comment) 2
New last valid event for Fjord: 21
Continue editing last valid events?(y/N/comment)
````

If you make a mistake, don't worry; actel will not let you select an event that is not from the current section (e.g. Fjord in the example above), nor an event that is previous to the currently defined last event for the previous section (e.g. if the last river event is event 6, you can not select event 5 as the fjord last event).

After you select the new event, you will be asked if you want to edit more last events. This also means that you can correct any changes you made, should you make a mistake.

Note:
  : Once you inspect the movement events, if you decide that all the events for a given section are invalid, you can select that section and, when asked which would be the "New last valid event", simply leave the field empty, and a new question will show up:

````
Would you like to edit the last valid events?(y/N/comment) y
Which last valid event would you like to edit? (1-3) 2
New last valid event for Fjord:
W: The inserted value is not numeric. Continuing will erase all Fjord related timestamps. Proceed?(y/N/comment) 
````

### Events with one detection

By default, actel avoids assigning [movement events with one detection as the first and/or last valid events](c-0_migration.html#cautious.assignment) for a given section. This is because these isolated events are more likely to be miss-detections than events with more than one detection. However, if it happens that all the movement events for a given section have only one detection, actel will ask you to decide which events should be used.

Since actel starts by selecting the last movement events for all sections and only then the first events, you will be asked to assign a last event and *only after* to determine the first event:

````
W: No Sea detection events with more than one detection were found for fish R64K-4575. Opening movements list for inspection.

[...]

Which event should be considered the LAST Sea detection event?(comment) 5
Which event should be considered the FIRST Sea detection event?(comment) 
````
Note:
  : Like above, if you believe that the events for that section are not valid, you can tell actel to discard them. When prompted for the last or first movement event of a section, just press enter without any input.

If you believe that the cautious assignment rule is not suitable for your study area (i.e. your fish move very fast or your receiver range is limited), you can [disable `cautious.assignment` when you run the analysis](c-0_migration.html#cautious.assignment).

## Combining the time data with the biometrics

The hardest part is done. Now, actel will automatically combine the time information with the information you included in the biometrics file. This new data frame is called *status.df*, and will be available to you in the function output. It is also here that the [`success.arrays` variable](c-0_migration.html#success.arrays) comes in. If your fish was last detected on an one of those arrays, it's fate will be assigned as "Succeeded".

## Inspecting the results

Finally, actel will compile some summary tables, prepare the report, and finish up. 

__[Learn more about the results of migration()](c-2_migration_results.html)__


[Back to top.](#)